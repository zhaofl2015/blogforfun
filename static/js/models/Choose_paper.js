// Generated by CoffeeScript 1.9.3
(function() {
  var Choose_paper;

  Choose_paper = (function() {
    Choose_paper.prototype.papers = ko.observableArray([]);

    Choose_paper.prototype.choose_ownerpaper_array = ko.observableArray([]);

    Choose_paper.prototype.choose_ownerpaper_value = ko.observable('');

    Choose_paper.prototype.question_index_array = ko.observableArray([]);

    Choose_paper.prototype.question_index_value = ko.observable('');

    Choose_paper.prototype._paper_to_edit = ko.observable('');

    function Choose_paper(papers) {
      var j, len, paper, ref;
      if (papers == null) {
        papers = [];
      }
      this.papers(papers);
      ref = this.papers();
      for (j = 0, len = ref.length; j < len; j++) {
        paper = ref[j];
        if (paper.number === '') {
          this._paper_to_edit(paper);
        }
      }
      if (typeof this._paper_to_edit() !== 'undefined') {
        this.papers.remove(this._paper_to_edit());
        this.choose_ownerpaper_value(this._paper_to_edit().title);
        this.get_question_index(this._paper_to_edit().paper_id);
      }
      return;
    }

    Choose_paper.prototype.update_choose_papers = function() {
      var that;
      that = this;
      if (this.updateTimer) {
        clearTimeout(this.updateTimer);
        this.updateTimer = null;
      }
      if (this.updateAjax) {
        this.updateAjax.abort();
        this.updateAjax = null;
      }
      this.updateTimer = setTimeout(function() {
        that.updateAjax = $.post('/xx/questions/paper_hints', {
          title: that.choose_ownerpaper_value()
        }, function(data) {
          var i;
          if (data.success) {
            that.choose_ownerpaper_array.removeAll();
            for (i in data.hints) {
              if (data.hints.hasOwnProperty(i)) {
                that.choose_ownerpaper_array.push({
                  paperid: i,
                  papername: data.hints[i]
                });
              }
            }
            that.get_question_index();
          }
        });
      });
    };

    Choose_paper.prototype._get_paper_id = function() {
      var target_paper_id, that;
      that = this;
      target_paper_id = false;
      ko.utils.arrayForEach(this.choose_ownerpaper_array(), function(el) {
        if (el.papername === that.choose_ownerpaper_value()) {
          target_paper_id = el.paperid;
        }
      });
      return target_paper_id;
    };

    Choose_paper.prototype.get_question_index = function(paper_id) {
      var target_paper_id, that;
      that = this;
      target_paper_id = paper_id || this._get_paper_id();
      if (target_paper_id) {
        $.post('/xx/questions/question_index_hints', {
          paper_id: target_paper_id
        }, function(data) {
          var d, j, len, ref;
          if (data.success) {
            that.question_index_array.removeAll();
            that.question_index_array.push("请选择");
            ref = data.indices;
            for (j = 0, len = ref.length; j < len; j++) {
              d = ref[j];
              that.question_index_array.push(d);
            }
          }
        });
      }
    };

    Choose_paper.prototype.add_paper = function() {
      var index, numbers, paper_id;
      paper_id = typeof this._paper_to_edit() === "undefined" || this._paper_to_edit() === "" ? this._get_paper_id() : this._paper_to_edit().paper_id;
      index = this.question_index_value();
      if (!!(paper_id && index)) {
        this.papers.push({
          paper_id: paper_id,
          title: this.choose_ownerpaper_value(),
          number: index
        });
        this.papers(_.sortBy(this.papers(), function(paper) {
          return paper.title + paper.number + paper.paper_id;
        }));
        numbers = [];
        this.papers(_.filter(this.papers(), function(paper) {
          if (numbers.indexOf(paper.title + paper.number + paper.paper_id) === -1) {
            numbers.push(paper.title + paper.number + paper.paper_id);
            return true;
          } else {
            alert("题号重复");
            return false;
          }
        }));
        this.question_index_array.removeAll();
        this.question_index_value('');
        this.choose_ownerpaper_array.removeAll();
        this.choose_ownerpaper_value('');
      }
    };

    Choose_paper.prototype.delete_paper = function(self) {
      self.papers.remove(this);
    };

    return Choose_paper;

  })();

  this.Choose_paper = Choose_paper;

}).call(this);

//# sourceMappingURL=Choose_paper.js.map
