// Generated by CoffeeScript 1.9.3
(function() {
  var attr_workbook_content;

  attr_workbook_content = (function() {
    function attr_workbook_content() {}

    attr_workbook_content.prototype.workbook_contents = ko.observableArray([]);

    attr_workbook_content.prototype.search_workbook_content_name = ko.observable('');

    attr_workbook_content.prototype.search_workbook_category_id = ko.observable('');

    attr_workbook_content.prototype.search_num = ko.observable('');

    attr_workbook_content.prototype.is_part = ko.observable(false);

    attr_workbook_content.prototype.part_index = ko.observable(0);

    attr_workbook_content.prototype.number_voice_text = ko.observable('');

    attr_workbook_content.prototype.search_workbook_content = function() {
      var that;
      that = this;
      $.popbox({
        title: '选择所属教辅',
        customPos: {
          marginTop: '-260px'
        },
        content: '<div class="workbookpanel"><div class="row"><div class="col-sm-6"><select class="form-control chooseseries"><option value="-1">选择所属丛书</option></select></div><div class="col-sm-6"><select class="form-control chooseworkbook"><option value="-1">选择教辅名称</option></select></div></div><div class="catalogtree"><ul class="ztree"></ul></div></div>',
        onOpen: function() {
          return $.post('/workbook/service-get-workbook-series', {
            subject_id: that.subject_id
          }).success(function(data) {
            var html, i, len, ref, s;
            if (data.success) {
              html = '<option value="-1">选择所属丛书</option>';
              ref = data.data;
              for (i = 0, len = ref.length; i < len; i++) {
                s = ref[i];
                html += '<option value="' + s.id + '">' + s.name + '</option>';
              }
              return $('.chooseseries').html(html).unbind('change').change(function() {
                var workbook_series_id;
                workbook_series_id = $(this).val();
                if (workbook_series_id !== '-1') {
                  return that._search_workbook_list(workbook_series_id);
                }
              });
            } else {
              return $tools.msgTip('获取丛书列表数据失败，请重试');
            }
          });
        },
        onOk: function() {
          var c, checked;
          checked = that.wbTree.getCheckedNodes(true);
          if (checked.length > 0) {
            c = checked[0];
            that.search_workbook_category_id(c.parent_workbook_catalog_id);
            that.search_workbook_content_name(c.name);
            that.is_part(c.is_part);
            return that.part_index(c.part_index);
          } else {
            return false;
          }
        }
      });
    };

    attr_workbook_content.prototype._search_workbook_list = function(workbook_series_id) {
      var that;
      that = this;
      $.post('/workbook/service-get-workbooks', {
        workbook_series_id: workbook_series_id
      }).success(function(data) {
        var html, i, len, ref, w;
        if (data.success) {
          html = '<option value="-1">选择教辅名称</option>';
          ref = data.data;
          for (i = 0, len = ref.length; i < len; i++) {
            w = ref[i];
            html += '<option value="' + w.id + '">' + w.title + '</option>';
          }
          $('.chooseworkbook').html(html).unbind('change').change(function() {
            var workbook_id;
            workbook_id = $(this).val();
            if (workbook_id !== '-1') {
              return that._search_workbood_catalog(workbook_id);
            }
          });
          return $('.pb_container:visible .catalogtree .ztree').html('');
        } else {
          return $tools.msgTip('获取教辅列表数据失败，请重试');
        }
      });
    };

    attr_workbook_content.prototype._search_workbood_catalog = function(workbook_id) {
      var that;
      that = this;
      $tools.ajax({
        url: '/workbook/service-get-workbook-catalog',
        data: {
          workbook_id: workbook_id
        },
        showLoadingMask: false,
        success: function(data) {
          var setting;
          if (data.data.length > 0) {
            data = that._format_catalog_data(data.data);
            setting = {
              check: {
                enable: true,
                chkStyle: "radio",
                radioType: "all"
              },
              view: {
                selectedMulti: false
              },
              async: {
                url: '/workbook/service-get-workbook-catalog',
                enable: true,
                dataType: 'json',
                autoParam: ['parent_workbook_catalog_id'],
                dataFilter: function(treeId, parentNode, responseData) {
                  return that._format_catalog_data(responseData.data);
                }
              }
            };
            return that.wbTree = $.fn.zTree.init($(".catalogtree .ztree"), setting, data);
          } else {
            return $('.pb_container:visible .catalogtree .ztree').text('暂无数据');
          }
        }
      });
    };

    attr_workbook_content.prototype._format_catalog_data = function(data) {
      var d, i, len, result;
      result = [];
      for (i = 0, len = data.length; i < len; i++) {
        d = data[i];
        result.push({
          parent_workbook_catalog_id: d.id || d.workbook_catalog_id,
          name: d.name || d.title,
          isParent: d.could_expand,
          chkDisabled: !d.could_add_question,
          is_part: d.is_part,
          part_index: d.part_index
        });
      }
      return result;
    };

    attr_workbook_content.prototype.add_workbook_content = function() {
      if (this.search_workbook_category_id() && this.search_num()) {
        this.workbook_contents.push({
          id: this.search_workbook_category_id(),
          name: this.search_workbook_content_name(),
          number: this.search_num(),
          is_part: this.is_part(),
          part_index: this.part_index(),
          detail: '',
          number_voice_text: this.number_voice_text()
        });
        this.search_workbook_category_id('');
        this.search_workbook_content_name('');
        this.search_num('');
        return this.number_voice_text('');
      }
    };

    return attr_workbook_content;

  })();

  this.attr_workbook_content = attr_workbook_content;

}).call(this);

//# sourceMappingURL=attr_workbook_content.js.map
